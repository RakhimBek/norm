<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Обработка почтовых адресов России</title>
    <meta name="description" content="Обработка почтовых адресов">
    <link href="{{ url_for('static', path='/index.css') }}" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script src="https://api-maps.yandex.ru/2.1/?apikey=594c11a0-3529-4668-87a6-b1383dc993c3&lang=ru_RU"
            type="text/javascript">
    </script>
</head>

<body>


<div class="tabs">
    <header>
        <ul class="tabs__caption">
            <li class="active">Данные</li>
            <li>Проверка адреса</li>
        </ul>
    </header>


    <div class="tabs__content active">
        <div class="instructions-wrapper">
            <section class="instructions">
                <h1>Как начать пользоваться</h1>
                <div class="instructions-list">
                    <div class="instructions-item">
                        <div class="instructions-icon">1</div>
                        <div class="instructions-description">Загрузите файл с нераспознанными адресами</div>
                    </div>
                    <div class="instructions-item">
                        <div class="instructions-icon">2</div>
                        <div class="instructions-description">Мы проанализируем его и сформируем готовый список
                            адресов
                        </div>
                    </div>
                    <div class="instructions-item">
                        <div class="instructions-icon">3</div>
                        <div class="instructions-description">Скачайте файл</div>
                    </div>
                </div>
            </section>
        </div>
        <main>
            <section class="file-upload">
                <h1 class="title-left">Загрузите исходный файл</h1>
                <img id="loadImg" src="{{ url_for('static', path='/load.gif') }}"/>
                <form class="upload-form">
                    <input id="file" class="upload-field" type="file" accept=".csv">
                    <a href="#" class="submit-link">Проверить</a>

                    <!--
                    <input class="submit-button" type="submit"> -->
                </form>


                <p class="file-format-info">Файл должен быть в формате .csv</p>

            </section>
        </main>
    </div>


    <div class="tabs__content">
        <main>
            <section class="file-upload">
                <h1 class="title-left">Введите адрес</h1>
                <form class="upload-form">
                    <input id="checkfile" class="adress-field" type="text">
                    <a href="#" class="check-link">Проверить</a>

                    <!--
                    <input class="submit-button" type="submit"> -->
                </form>


            </section>
            <div id="map"></div>
        </main>
    </div>

</div>

</body>

<script type="text/javascript">

    function startLoadingAnimation() {
        var imgObj = $("#loadImg");
        imgObj.css("opacity", 100);
    }

    function stopLoadingAnimation() {
        var imgObj = $("#loadImg");
        imgObj.css("opacity", 0);
    }

    $('.submit-link').click(function (event) {

        event.stopPropagation(); // Остановка происходящего
        event.preventDefault();  // Полная остановка происходящего
        startLoadingAnimation();

        // Создадим данные формы и добавим в них данные файлов из files
        let file_data = $('#file').prop('files')[0];
        let form_data = new FormData();
        form_data.append('file', file_data);

        // Отправляем запрос
        fetch("/api/file/upload/", {
            "method": "post",
            "Content-Type": "multipart/form-data;boundary='",
            "body": form_data
        })
            .then(response => console.log(response))
            .then(response => response.json())
            .then(data => data.filename)
            .then(filename => window.location = '/api/file/' + filename)
            .catch((error) => console.log(error))
            .finally(() => stopLoadingAnimation())
            .catch(error => console.log(error));
    });

    (function ($) {
        $(function () {

            $('ul.tabs__caption').on('click', 'li:not(.active)', function () {
                $(this)
                    .addClass('active').siblings().removeClass('active')
                    .closest('div.tabs').find('div.tabs__content').removeClass('active').eq($(this).index()).addClass('active');
            });

        });
    })(jQuery);
</script>

<script type="text/javascript">

    $('.check-link').click(function (event) {
        event.stopPropagation(); // Остановка происходящего
        event.preventDefault();  // Полная остановка происходящего

        fetch('/api/normalize', {
            "method": "post",
            "Content-Type": "application/json",
            "body": JSON.stringify({
                "string": $("input:text").val()
            })
        })
            .then(response => response.json())
            .then(data => data.string)
            .then(val => $('.adress-field').val(val))
            .catch((response) => {
                // something wrong has happen
                console.log(response);
            });

        let adress = $("input:text").val();
        fetch("https://geocode-maps.yandex.ru/1.x/?apikey=594c11a0-3529-4668-87a6-b1383dc993c3&format=json&geocode=" + adress)
            .then(response => response.json())
            .then(data => data.response.GeoObjectCollection.featureMember[0].GeoObject.Point)
            .then(point => point.pos.split(' ').reverse())
            .then(position => {
                let geoObject = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: position
                    }
                }, {
                    preset: 'islands#blackStretchyIcon'
                });

                $("#map").empty();
                ymaps.ready(() => {
                    new ymaps.Map("map", {
                        center: position,
                        zoom: 17.5
                    }, {
                        searchControlProvider: 'yandex#search'
                    })
                        .geoObjects
                        .add(geoObject);
                });
            })
            .catch(error => console.log(error))
            .finally(() => stopLoadingAnimation())
    });


</script>
</html>